{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block style %}
<link rel="stylesheet" href="/static/plugins/select2/css/select2.min.css">
<link rel="stylesheet" href="/static/plugins/select2-bootstrap4-theme/select2-bootstrap4.min.css">
{% endblock %}

{% block content %}
<div class="<div class=" container-fluid">
    <div class="row">

        <div class="box d-flex w-100 col-3">
            <div class="card col">

                <div class="card-header">
                    <h3 class="card-title">{{ title }}</h3>

                    <div class="card-tools">
                        <button type="button" class="btn btn-tool" data-card-widget="collapse">
                            <i class="fas fa-minus"></i>
                        </button>
                        <button type="button" class="btn btn-tool" data-card-widget="remove">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>

                <div class="card-body">
                    <div class="row">
                        <div class="col-md-11">
                            <form {% if is_prod%}action="{{ https_url_for(request,'results') }}"{%else%}action="{{ url_for('results') }}"{%endif%} method="POST">
                                <div class="form-group">
                                    <label>O'quv yili</label>
                                    <select id="exam-year" name="examYear" class="form-control select2" style="width: 100%;">
                                        {% for year, quarters in periods.items() %}
                                        {% if examYear %}
                                            <option value="{{ year }}" {% if year == examYear %}selected="selected"{% endif %}>{{ year }}</option>
                                        {% else %}
                                            <option value="{{ year }}" {% if loop.first %}selected="selected"{% endif %}>{{ year }}</option>
                                        {% endif %}
                                        {% endfor %}
                                    </select>
                                    
                                    <label for="exam-quarter">Chorak:</label>
                                    <select id="exam-quarter" name="examQuarter" class="form-control select2" style="width: 100%;">
                                        {% if examQuarter and periods.get(examYear) %}
                                            {% for quarter in periods[examYear] %}
                                                <option value="{{ quarter }}" {% if quarter == examQuarter %}selected="selected"{% endif %}>
                                                    {{ quarter }}
                                                </option>
                                            {% endfor %}
                                        {% endif %}
                                    </select>
                                    <label for="territory">Hudud:</label>
                                    <select id="territory" name="territory" class="form-control select2"
                                        style="width: 100%;">
                                        {% for val, key in all_territories.items() %}
                                        <option value="{{ val }}" {% if val==territory %}selected="selected" {% endif %}>{{
                                            key }}</option>
                                        {% endfor %}

                                    </select>
                                    <label for="region">Tuman:</label>
                                    <select id="region" name="region" class="form-control select2" style="width: 100%;">
                                        <option value="" selected>Barcha tumanlar</option> <!-- Default option -->
                                    </select>
                                    <label for="school">Maktab:</label>
                                    <select id="school" name="school" class="form-control select2" style="width: 100%;">
                                        <option value="" selected>Barcha maktablar</option> <!-- Default option -->
                                    </select>
                                    <label for="studyClass">Sinf:</label>
                                    <select id="studyClass" name="studyClass" class="form-control select2"
                                        style="width: 100%;">
                                        {% for val, key in all_classes.items() %}
                                        <option value="{{ val }}" {% if val==studyClass %}selected="selected" {% endif %}>{{
                                            key }}</option>
                                        {% endfor %}
                                    </select>
                                    <label for="subject">Fan:</label>
                                    <select id="subject" name="subject" class="form-control select2" style="width: 100%;">
                                        {% for val, key in all_subjects.items() %}
                                        <option value="{{ val }}" {% if val==subject %}selected="selected" {% endif %}>{{
                                            key }}</option>
                                        {% endfor %}
                                    </select>
                                    <label for="examMethod">Sinov turi:</label>
                                    <select id="examMethod" name="examMethod" class="form-control select2"
                                        style="width: 100%;">
                                        {% for val, key in all_exam_methods.items() %}
                                        <option value="{{ val }}" {% if val==examMethod %}selected="selected" {% endif
                                            %}>{{ key }}</option>
                                        {% endfor %}
                                    </select>
                                    <button type="submit" class="btn btn-primary" style="margin-top: 1em;">Saralash</button>
                
                                </div>
                            </form>
                        </div>
                    </div>
                    <!-- /.row -->
                </div>

                <!-- /.card-body -->
            </div>
        </div>

        <!-- <div class="row"> -->
        <div class="box d-flex flex-column w-100 col">
            <div class="d-flex align-items-center justify-space-between gap-3 p-3 w-100">
                {% if examYear and examQuarter %}
                    <div class="col-md-6">
                        <h2 class="h-auto">{% if territory %}{{ territory }} {%else%} Barcha hudular {% endif %} {{ school }} ko'rsatkichlari</h2>
                    </div>
                    <div class="col-md-6">
                        <button id="year-btn" type="button" class="btn h-auto btn-outline-primary mt-0 mr-3">
                            {{ examYear }}-o'quv yili
                        </button>
                        <button id="quarter-btn" type="button" class="btn h-auto btn-outline-primary mt-0 mr-3">
                            {{ examQuarter }}-chorak
                        </button>
                        <button id="subject-btn" type="button" class="btn h-auto btn-outline-primary mt-0 mr-3">
                            {% if subject %}{{ all_subjects[subject] }}{% else %}Barcha fanlar{% endif %}
                        </button>
                        <button id="class-btn" type="button" class="btn h-auto btn-outline-primary mt-0 mr-3">
                            {% if studyClass %}{{ all_classes[studyClass] }}-sinf{% else %}Barcha sinflar {% endif %}
                        </button>
                        <button id="method-btn" type="button" class="btn h-auto btn-outline-primary mt-0">
                            {% if examMethod %}{{ all_exam_methods[examMethod] }} sinov turi{% else %}Barcha sinov turi{% endif %}
                        </button>
                    </div>
                {% else %}
                    <h2 class="h-auto">Kerakli ma'lumotlarni kiriting</h2>
                {% endif %}

            </div>

            <div class="row w-100 d-flex align-items-stretch" style="margin-bottom: 1em;">
                {% if exam_method_results and exam_method_results | length > 0 %}
                <div class="col-4 h-100">
                    <!-- PIE CHART -->
                    <div class="card card-success h-100">
                        <div class="card-header">
                            <div class="card-tools">
                                <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <button type="button" class="btn btn-tool" data-card-widget="remove">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <h3 class="text-center">Sinov turlari boâ€˜yicha CHSB qamrovi</h3>
                            <h2 class="text-center">{{ exam_method_results[0]['students_count'] }}</h2>
                            <p class="text-center">Jami qatnashganlar</p>
                            <canvas id="pieChart" style="min-height: 250px; height: 250px; max-height: 250px; max-width: 100%;"></canvas>
                            <div class="row">
                                <div class="col-6 callout" id="callout-online" style="display: none;">
                                    <p>Online: <span id="online-count">0</span></p>
                                </div>
                                <div class="col-6 callout" id="callout-offline" style="display: none;">
                                    <p>Offline: <span id="offline-count">0</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-4 h-100">
                    <div class="card card-success h-100">
                        <div class="card-header">
                            <div class="card-tools">
                                <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <button type="button" class="btn btn-tool" data-card-widget="remove">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="chart">
                                <h3 class="text-center">Sinov turlari boâ€˜yicha natijalari</h3>
                                <canvas id="barChart" style="min-height: 250px; height: 250px; max-height: 250px; max-width: 100%;"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if avg_by_territory and avg_by_territory | length > 0 %}
                <div class="col-4 h-100">
                    <div class="card card-success h-100">
                        <div class="card-header">
                            <div class="card-tools">
                                <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <button type="button" class="btn btn-tool" data-card-widget="remove">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="chart">
                                <h3 class="text-center">Umumiy natijalar</h3>
                                <canvas id="barChart2" style="min-height: 250px; height: 350px; max-height: 350px; max-width: 100%;"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

        </div>
    </div>

    <div class="row">
        {% if study_class_results and study_class_results | length > 0 %}
        <div class="col-md-6">
            <div class="card card-success">
                <div class="card-header">


                    <div class="card-tools">
                        <button type="button" class="btn btn-tool" data-card-widget="collapse">
                            <i class="fas fa-minus"></i>
                        </button>
                        <button type="button" class="btn btn-tool" data-card-widget="remove">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart">
                        <h3 class="text-center">Sinflar natijalari</h3>
                        <canvas id="barChart5"
                            style="min-height: 250px; height: 250px; max-height: 350px; max-width: 100%;"></canvas>
                    </div>
                </div>
                <!-- /.card-body -->
            </div>
            <!-- /.card -->
            <!-- /.card -->
        </div>
        {%endif%}
        {% if some_subject_result and some_subject_result | length > 0 %}
        <div class="col-md-6">
            <div class="card card-success">
                <div class="card-header">


                    <div class="card-tools">
                        <button type="button" class="btn btn-tool" data-card-widget="collapse">
                            <i class="fas fa-minus"></i>
                        </button>
                        <button type="button" class="btn btn-tool" data-card-widget="remove">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart">
                        <h3 class="text-center">Fanni o'zlashtirish ko'rsatkichi</h3>
                        <canvas id="barChart4"
                            style="min-height: 250px; height: 250px; max-height: 350px; max-width: 100%;"></canvas>
                    </div>
                </div>
                <!-- /.card-body -->
            </div>
            <!-- /.card -->
            <!-- /.card -->
        </div>
        {% endif %}
    </div>

    {% if subject_results and subject_results | length > 0 %}
        {% if not subject_not_chosen %}
        <div class="col-md-12 margin-top">
            <div class="card card-success">
                <div class="card-header">


                    <div class="card-tools">
                        <button type="button" class="btn btn-tool" data-card-widget="collapse">
                            <i class="fas fa-minus"></i>
                        </button>
                        <button type="button" class="btn btn-tool" data-card-widget="remove">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart">
                        <h3 class="text-center">Umumiy natijalar</h3>
                        <canvas id="barChart3"
                            style="min-height: 250px; height: 350px; max-height: 450px; max-width: 100%;"></canvas>
                    </div>
                </div>
                <!-- /.card-body -->
            </div>
            <!-- /.card -->
            <!-- /.card -->
        </div>
        {%else%}
        <div class="col-md-12 margin-top">
            <div class="card card-success">
                <div class="card-header">


                    <div class="card-tools">
                        <button type="button" class="btn btn-tool" data-card-widget="collapse">
                            <i class="fas fa-minus"></i>
                        </button>
                        <button type="button" class="btn btn-tool" data-card-widget="remove">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart">
                        <h3 class="text-center">Umumiy natijalar</h3>
                        <canvas id="barChart3_1"
                            style="min-height: 250px; height: 350px; max-height: 450px; max-width: 100%;"></canvas>
                    </div>
                    <div class="chart margin-top">
                        <h3 class="text-center"></h3>
                        <canvas id="barChart3_2"
                            style="min-height: 250px; height: 350px; max-height: 450px; max-width: 100%;"></canvas>
                    </div>
                </div>
                <!-- /.card-body -->
            </div>
            <!-- /.card -->
            <!-- /.card -->
        </div>
        {% endif %}
    {% endif %}

    {% if table_results and table_results | length > 0 %}
    <!-- <div class="container-fluid"></div> -->
    <div class="row">
        <div class="col-12">
            <!-- /.card -->

            <div class="card">
                <div class="card-header">
                    <h3 style="text-align: center;"><b>{{ table_title }}</b></h3>
                    <h6 style="text-align: center; color:darkgrey;">Fanlar boâ€˜yicha natijalar (%)</h6>
                </div>
                <!-- /.card-header -->
                <div class="card-body">
                    <table class="table table-head-fixed text-nowrap table-bordered">
                        <thead>
                          <tr>
                            <!-- Add index header -->
                            <!-- <th>â„–</th> -->
                            {% for key in table_results[0].keys() %}
                              <th class="text-center">{{ (table_headers[key] if key in table_headers else key | capitalize) | safe }}</th>
                            {% endfor %}
                          </tr>
                        </thead>
                        <tbody>
                          {% for result in table_results %}
                            <tr>
                              <!-- Display the row index -->
                              <!-- <td class="text-center">{{ loop.index }}</td> -->
                              {% for key in result.keys() %}
                                <td>
                                    {{ result[key] if result[key] is not none else "" }}
                                </td>
                              {% endfor %}
                            </tr>
                          {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div class="card-footer clearfix">
                    <ul class="pagination pagination-sm m-0 float-right" id="pagination">
                      {% if page > 1 %}
                        <!-- Previous Button -->
                        <li class="page-item">
                          <a class="page-link" href="#" data-page="{{ page - 1 }}">&laquo;</a>
                        </li>
                      {% endif %}
                  
                      {% if page > 2 %}
                        <!-- First Page -->
                        <li class="page-item">
                          <a class="page-link" href="#" data-page="1">1</a>
                        </li>
                        {% if page > 3 %}
                          <!-- Ellipsis -->
                          <li class="page-item disabled">
                            <a class="page-link" href="#">...</a>
                          </li>
                        {% endif %}
                      {% endif %}
                  
                      <!-- Current Page and One Before/After -->
                      {% for p in range(page - 1, page + 2) %}
                        {% if p >= 1 and p <= totalPages %}
                          <li class="page-item {% if p == page %}active{% endif %}">
                            <a class="page-link" href="#" data-page="{{ p }}">{{ p }}</a>
                          </li>
                        {% endif %}
                      {% endfor %}
                  
                      {% if page < totalPages - 1 %}
                        {% if page < totalPages - 2 %}
                          <!-- Ellipsis -->
                          <li class="page-item disabled">
                            <a class="page-link" href="#">...</a>
                          </li>
                        {% endif %}
                        <!-- Last Page -->
                        <li class="page-item">
                          <a class="page-link" href="#" data-page="{{ totalPages }}">{{ totalPages }}</a>
                        </li>
                      {% endif %}
                  
                      {% if page < totalPages %}
                        <!-- Next Button -->
                        <li class="page-item">
                          <a class="page-link" href="#" data-page="{{ page + 1 }}">&raquo;</a>
                        </li>
                      {% endif %}
                    </ul>
                </div>
                <!-- /.card-body -->
            </div>
            <!-- /.card -->
        </div>
        <!-- /.col -->
    </div>
    {% endif %}
    <!-- /.row -->
</div>


{% endblock %}

<!-- </script> -->
{% block scripts %}
<!-- DataTables  & Plugins -->
<script src="/static/plugins/datatables/jquery.dataTables.min.js"></script>
<script src="/static/plugins/datatables-bs4/js/dataTables.bootstrap4.min.js"></script>
<script src="/static/plugins/datatables-responsive/js/dataTables.responsive.min.js"></script>
<script src="/static/plugins/datatables-responsive/js/responsive.bootstrap4.min.js"></script>
<script src="/static/plugins/datatables-buttons/js/dataTables.buttons.min.js"></script>
<script src="/static/plugins/datatables-buttons/js/buttons.bootstrap4.min.js"></script>
<script src="/static/plugins/jszip/jszip.min.js"></script>
<script src="/static/plugins/pdfmake/pdfmake.min.js"></script>
<script src="/static/plugins/pdfmake/vfs_fonts.js"></script>
<script src="/static/plugins/datatables-buttons/js/buttons.html5.min.js"></script>
<script src="/static/plugins/datatables-buttons/js/buttons.print.min.js"></script>
<script src="/static/plugins/datatables-buttons/js/buttons.colVis.min.js"></script>
<script src="/static/plugins/chart.js/Chart.min.js"></script>
<script src="/static/plugins/chart.js/chartjs-plugin-datalabels.min.js"></script>
<script>
    var is_prod = "{{ is_prod }}" == "True";
    var regionListUrl = "";
    if (is_prod){
        regionListUrl = "{{ https_url_for(request,'region_list') }}";
    }
    else{
        regionListUrl = "{{ url_for('region_list') }}";
    }
    // Define the provided values
    var providedTerritory = "{{ territory }}";
    var providedRegion = "{{ region }}";
    providedRegion =  providedRegion.replace(/&#39;/g, "'");
    var providedExamYear = "{{ examYear }}";  // Make sure to pass examYear to the template
    var providedExamQuarter = "{{ examQuarter }}";  // Make sure to pass examQuarter to the template

    function fetchRegionList(territory, examYear, examQuarter, selectedRegion) {
        const regionSelect = document.getElementById('region');

        // Clear current options and set the default option
        regionSelect.innerHTML = '<option value="" selected>Tumanni tanlang</option>';

        if (territory && examYear && examQuarter) {
            fetch(regionListUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    territory: territory,
                    examYear: examYear,
                    examQuarter: examQuarter
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data && Array.isArray(data)) {
                        // Populate the school select with options from the array
                        data.forEach(regionName => {
                            const option = document.createElement('option');
                            option.value = regionName;
                            option.textContent = regionName;

                            // Set the option as selected if it matches provided school
                            if (regionName === selectedRegion) {
                                option.selected = true;
                            }
                            regionSelect.appendChild(option);
                        });
                    }
                })
                .catch(error => console.error('Error fetching school list:', error));
        }
    }

    // Event listener for territory selection change
    document.getElementById('territory').addEventListener('change', function () {
        const territory = this.value;
        const examYear = document.getElementById('exam-year').value;
        const examQuarter = document.getElementById('exam-quarter').value;

        fetchRegionList(territory, examYear, examQuarter, "");
    });

    // Automatically fetch school list if values are provided
    document.addEventListener('DOMContentLoaded', function () {
        if (providedTerritory && providedExamYear && providedExamQuarter) {
            fetchRegionList(providedTerritory, providedExamYear, providedExamQuarter, providedRegion);
        }
    });
</script>
<script>
    var is_prod = "{{ is_prod }}" == "True";
    var schoolListUrl = "";
    if (is_prod){
        schoolListUrl = "{{ https_url_for(request,'school_list') }}";
    }
    else{
        schoolListUrl = "{{ url_for('school_list') }}";
    }
    // Define the provided values
    var providedTerritory = "{{ territory }}";
    var providedRegion = "{{ region }}";
    var providedSchool = "{{ school }}";
    var providedExamYear = "{{ examYear }}";  // Make sure to pass examYear to the template
    var providedExamQuarter = "{{ examQuarter }}";  // Make sure to pass examQuarter to the template
    providedSchool =  providedSchool.replace(/&#39;/g, "'");

    function fetchSchoolList(territory, examYear, examQuarter, region, selectedSchool) {
        const schoolSelect = document.getElementById('school');

        // Clear current options and set the default option
        schoolSelect.innerHTML = '<option value="" selected>Maktabni Tanlang</option>';

        if (territory && examYear && examQuarter && region) {
            fetch(schoolListUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    territory: territory,
                    examYear: examYear,
                    examQuarter: examQuarter,
                    region: region
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data && Array.isArray(data)) {
                        // Populate the school select with options from the array
                        data.forEach(schoolName => {
                            const option = document.createElement('option');
                            option.value = schoolName;
                            option.textContent = schoolName;

                            // Set the option as selected if it matches provided school
                            if (schoolName === selectedSchool) {
                                option.selected = true;
                            }
                            schoolSelect.appendChild(option);
                        });
                    }
                })
                .catch(error => console.error('Error fetching school list:', error));
        }
    }

    // Event listener for territory selection change
    document.getElementById('region').addEventListener('change', function () {
        const territory = document.getElementById('territory').value;
        const examYear = document.getElementById('exam-year').value;
        const examQuarter = document.getElementById('exam-quarter').value;
        const region = this.value;

        console.log(territory, examYear, examQuarter, region);

        fetchSchoolList(territory, examYear, examQuarter, region, "");
    });

    // Automatically fetch school list if values are provided
    document.addEventListener('DOMContentLoaded', function () {
        if (providedTerritory && providedRegion && providedExamYear && providedExamQuarter) {
            fetchSchoolList(providedTerritory, providedExamYear, providedExamQuarter, providedRegion, providedSchool);
        }
    });
</script>
<script>
    const periods = {{ periods | tojson }};
    const examYearSelect = document.getElementById("exam-year");
    const examQuarterSelect = document.getElementById("exam-quarter");
    const selectedQuarter = "{{ examQuarter|default('') }}"; // Use the posted quarter if available

    // Function to populate quarters based on the selected year
    function populateQuarters(year) {
        examQuarterSelect.innerHTML = "";  // Clear existing options
        if (periods[year]) {
            periods[year].forEach(quarter => {
                const option = document.createElement("option");
                option.value = quarter;
                option.textContent = quarter;
                if (quarter === selectedQuarter) {
                    option.selected = true; // Mark the selected quarter
                }
                examQuarterSelect.appendChild(option);
            });
        }
    }

    // Event listener to update quarters when a new year is selected
    examYearSelect.addEventListener("change", function() {
        populateQuarters(examYearSelect.value);
    });

    // Initial population of quarters for the first selected year
    document.addEventListener("DOMContentLoaded", () => {
        const defaultYear = examYearSelect.value;
        populateQuarters(defaultYear);
    });
</script>
<script>
    {% if table_results and table_results | length > 0 %}
    document.addEventListener("DOMContentLoaded", function () {
      const pagination = document.getElementById("pagination");

      var is_prod = "{{ is_prod }}" == "True";
      var results_api = "";
      if (is_prod){
        results_api = "{{ https_url_for(request,'results') }}";
      }
      else{
        results_api = "{{ url_for('results') }}";
      }
  
      pagination.addEventListener("click", function (event) {
        event.preventDefault();
        const target = event.target;
  
        if (target.tagName === "A" && target.dataset.page) {
          const page = target.dataset.page;
  
          // Collect necessary form data (if applicable)
          const formData = new FormData();
          examYear = document.getElementById("exam-year").value;
          examQuarter = document.getElementById("exam-quarter").value;
          territory = document.getElementById("territory").value;
          region = document.getElementById("region").value;
          studyClass = document.getElementById("studyClass").value;
          school = document.getElementById("school").value;
          examMethod = document.getElementById("examMethod").value;
          subject = document.getElementById("subject").value;

          formData.append("page", page);
          formData.append("examYear", examYear);
          formData.append("examQuarter", examQuarter);
          formData.append("territory", territory);
          formData.append("region", region);
          formData.append("studyClass", studyClass);
          formData.append("school", school);
          formData.append("examMethod", examMethod);
          formData.append("subject", subject);
  
          // Send request to the API
         // Send request to the API
        fetch(results_api, {
          method: "POST",
          body: formData,
        })
        .then((response) => {
            if (!response.ok) {
              throw new Error("Network response was not ok");
            }
            return response.text(); // Get the HTML response
          })
          .then((html) => {
            console.log("Received HTML from API:", html);

            // Parse the returned HTML
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, "text/html");

            // Update the table content
            const newTable = doc.querySelector(".card-body table");
            const currentTable = document.querySelector(".card-body table");

            if (newTable && currentTable) {
              currentTable.innerHTML = newTable.innerHTML;
              console.log("Table updated successfully.");
            } else {
              console.error("Table not found in the response.");
            }

            // Update pagination links
            const newPagination = doc.querySelector("#pagination");
            if (newPagination) {
              pagination.innerHTML = newPagination.innerHTML;
              console.log("Pagination updated successfully.");
            } else {
              console.error("Pagination not found in the response.");
            }
          })
          .catch((error) => {
            console.error("Error during fetch:", error);
        });
        }
      });
    });
    {% endif %}
</script>
<script>
    // $(function () {
    // Jinja2 provides exam_method_results as a JSON object
    {% if exam_method_results and exam_method_results | length > 0 %}
        var examMethodResults = {{ exam_method_results | tojson }};

        const exam_methods_dict = { "on": "Online", "off": "Offline" }
        const methods_colors = { "on": "rgba(30, 58, 138, 0.9)", "off": "rgba(147, 197, 253, 0.9)" }

        // Extract labels and data from exam_method_results
        var labels = examMethodResults.map(item => exam_methods_dict[item.exam_method]);
        var data = examMethodResults.map(item => item.percentage);
        var counts = examMethodResults.map(item => item.count);
        var colors = examMethodResults.map(item => methods_colors[item.exam_method]);

        let onlineExists = false;
        let offlineExists = false;

        examMethodResults.forEach(item => {
            if (item.exam_method === "on") {
                onlineExists = true;
                document.getElementById("online-count").textContent = item.count + ' ta';
                document.getElementById("callout-online").style.display = "block"; // Show Online block
            } else if (item.exam_method === "off") {
                offlineExists = true;
                document.getElementById("offline-count").textContent = item.count + ' ta';
                document.getElementById("callout-offline").style.display = "block"; // Show Offline block
            }
        });

        // Ensure only relevant methods are displayed
        if (!onlineExists) {
            document.getElementById("callout-online").style.display = "none"; // Hide Online block
        }
        if (!offlineExists) {
            document.getElementById("callout-offline").style.display = "none"; // Hide Offline block
        }


        // Donut chart setup
        var pieChartCanvas = $('#pieChart').get(0).getContext('2d')

        var pieData = {
            labels: labels,
            datasets: [{
                data: data, // Data for percentages
                counts: counts, // Data for counts
                backgroundColor: colors
            }]
        };

        if (data.length == 1) {
            pieData.datasets[0].borderWidth = 0; // Remove border for single data
        }

        var pieOptions = {
            maintainAspectRatio: false,
            responsive: true,
            cutoutPercentage: 1, // Small cutout for doughnut effect
            animation: {
                animateScale: true
            },
            elements: {
                arc: {
                    roundedCornersFor: 0 // Helps smooth edges in some cases
                }
            },
            plugins: {
                datalabels: {
                    color: '#fff',
                    display: true,
                    font: {
                        weight: 'bold',
                        size: 11
                    },
                    formatter: function (value, context) {
                        return value + '%';
                    }
                }
            },
            tooltips: {
                callbacks: {
                    label: function (tooltipItem, data) {
                        var dataset = data.datasets[tooltipItem.datasetIndex];
                        var label = data.labels[tooltipItem.index];
                        var count = dataset.counts[tooltipItem.index]; // Use the count data for tooltip
                        var percentage = dataset.data[tooltipItem.index];
                        return `${label}: ${count} (${percentage}%)`;
                    }
                }
            }
        };

        // Create pie or donut chart
        new Chart(pieChartCanvas, {
            type: 'pie',
            data: pieData,
            options: pieOptions,
            plugins: [ChartDataLabels]
        });


        // Define labels for the x-axis
        var labels = ['Natijalar'];

        var barChartData = {
            labels: labels, // Set x-axis labels
            datasets: examMethodResults.map(item => ({
                label: exam_methods_dict[item.exam_method],
                pointRadius: false,
                pointHighlightFill: '#fff',
                data: [item.result]
            }))
        };

        // custom background color for each dataset in the bar chart
        barChartData.datasets.forEach(function (dataset, i) {
            if (dataset.label === 'Online') {
                dataset.backgroundColor = 'rgba(30, 58, 138, 1)';
            } else {
                dataset.backgroundColor = 'rgba(147, 197, 253, 1)';
            }
        });

        var barChartCanvas = $('#barChart').get(0).getContext('2d');

        var barChartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            datasetFill: false,
            scales: {
                yAxes: [{
                    ticks: {
                        beginAtZero: true, // Start y-axis from 0,
                        max: 100 // Set maximum value for y-axis
                    }
                }],
                xAxes: [{
                    barPercentage: 0.6,      // Adjust width of each bar
                    categoryPercentage: 0.8, // Adjust spacing between bars
                }]
            },
            plugins: {
                datalabels: {
                    // anchor: 'end', // Position the labels on the top of each bar
                    align: 'top',
                    color: '#fff', // Color of the label text
                    font: {
                        weight: 'bold',
                        size: 12
                    },
                    formatter: function (value, context) {
                        return value + '%';
                    }
                }
            }
        };

        // Initialize the bar chart with Data Labels plugin
        new Chart(barChartCanvas, {
            type: 'bar',
            data: barChartData,
            options: barChartOptions,
            plugins: [ChartDataLabels] // Register the Data Labels plugin
        });
    {% endif %}

    // });
</script>
<script>
    {% if avg_by_territory and avg_by_territory | length > 0 %}
        // Data for avg_by_territory
        var avgByTerritory = {{ avg_by_territory | tojson }};

        // Check if there's a chosen territory provided
        var chosenTerritory = "{{ territory }}" // Use Jinja to pass the chosen territory, if any, to JavaScript

        // Extract labels (territories) and data (values)
        var labels = avgByTerritory.map(item => item.territory);
        var data = avgByTerritory.map(item => item.data);

        // Prepare bar chart data
        var barChartData = {
            labels: labels, // Set x-axis labels to territories
            datasets: [{
                label: 'Natijalar', // Label for the entire dataset
                data: data, // Data values for each territory
                backgroundColor: avgByTerritory.map(item =>
                    item.territory === chosenTerritory ? 'rgba(147, 197, 253, 1)' : 'rgba(30, 58, 138, 1)'
                ), // Highlight chosen territory with a different color
                borderColor: 'rgba(30, 58, 138, 1)',
                borderWidth: 1
            }]
        };

        // Get the canvas context
        var barChartCanvas = $('#barChart2').get(0).getContext('2d');

        // Define bar chart options
        var barChartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            datasetFill: false,
            scales: {
                yAxes: [{
                    ticks: {
                        beginAtZero: true, // Start y-axis from 0
                        max: 100 // Set maximum value for y-axis
                    }
                }],
                xAxes: [{
                    barPercentage: 0.5, // Control width of each bar (0.5 = 50% width)
                    categoryPercentage: 1.0, // Control space between categories
                    gridLines: {
                        offsetGridLines: true // Center the grid lines on bars
                    },
                    ticks: {
                        minRotation: 40,  // Force vertical label orientation
                        maxRotation: 40,  // Force vertical label orientation
                        autoSkip: false  // Ensure all labels are shown
                    }
                }]
            },
            plugins: {
                datalabels: {
                    anchor: 'end',       // Position the labels at the end (top) of each bar
                    align: 'top',      // Align label at the top center of the bar
                    color: '#000',       // Color of the label text
                    font: {
                        size: 9
                    }
                }
            }
        };

        // Initialize the bar chart with Data Labels plugin
        new Chart(barChartCanvas, {
            type: 'bar',
            data: barChartData,
            options: barChartOptions,
            plugins: [ChartDataLabels] // Register the Data Labels plugin
        });
    {% endif %}
</script>
<script>
    {% if subject_results and subject_results | length > 0 %}

    function reorderJsonArray(dataArray) {
        return dataArray.map(entry => {
            const reorderedEntry = {};
            var subjectKeys = {{ subject_results_keys | tojson }};

            // Reorder keys based on subjectKeys
            subjectKeys.forEach(key => {
                if (key in entry) {
                    reorderedEntry[key] = entry[key];
                }
            });

            // Retain additional keys (e.g., 'key') not in subjectKeys
            for (let extraKey in entry) {
                if (!subjectKeys.includes(extraKey)) {
                    reorderedEntry[extraKey] = entry[extraKey];
                }
            }

            return reorderedEntry;
        });
    }
    var subjectResultsKeys = {{ subject_results_keys | tojson }};
    var subject_not_chosen = "{{ subject_not_chosen }}";

    var subjectColours = {
        "" : "#732fae",
        "math": "#01b151",
        "algebra": "#feb473",
        "geometry": "#f78d6a",
        "physics": "#aeb279",
        "biology": "#5da9bd",
        "chemistry": "#5a7db8",
        "english": "#92d156",
        "literature": "#f7b5d1",
        "mother_tongue": "#f2r2d1",
        "mother_tongue_literature": "#c2b2d1",
        "russian": "#a2r2d1",

    }
        {% if not subject_not_chosen %}
            var subjectResults = {{ subject_results | tojson }};

            // Reorder data for each quarter
            subjectResults = reorderJsonArray(subjectResults);
            
            var all_subjects = {{ all_subjects | tojson }};

            // Extract subjects from the first item (assuming all items have the same structure)
            var subjects = subjectResultsKeys
                .filter(key => key.endsWith('_avg'))
                .map(key => key.replace('_avg', ''));

            console.log(subjects);

            // Extract territories and organize data by subject
            var labels = subjectResults.map(item => item.key); // Territory labels
            var datasets = subjects.map(subject => ({
                label: all_subjects[subject], // Subject name as the dataset label
                data: subjectResults.map(item => item[subject + '_avg']), // Data for each territory
                backgroundColor: subjectColours[subject], // Assign a random color to each subject
                borderColor: 'rgba(0, 0, 0, 0.1)',
                borderWidth: 1
            }));

            // Helper function to generate random colors

            // Get the canvas context for barChart3
            var barChartCanvas3 = $('#barChart3').get(0).getContext('2d');

            // Define bar chart options for barChart3
            var barChartOptions3 = {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    yAxes: [{
                        ticks: {
                            beginAtZero: true, // Start y-axis from 0
                            max: 100 // Set maximum value for y-axis
                        }
                    }],
                    xAxes: [{
                        barPercentage: 0.6,      // Adjust width of each bar
                        categoryPercentage: 0.8, // Adjust spacing between bars
                        ticks: {
                            minRotation: 40,  // Rotate labels to display vertically
                            maxRotation: 40,
                            autoSkip: false   // Ensure all labels are shown
                        }
                    }]
                },
                plugins: {
                    datalabels: {
                        anchor: 'end',        // Position the labels above each bar
                        align: 'top',         // Align label to the top of the bar
                        color: '#000',        // Label text color
                        font: {
                            weight: 'bold',
                            size: 10
                        }
                    }
                },
                legend: {
                    display: true // Disable legend display
                }
            };

            // Initialize barChart3 with the subject results data
            new Chart(barChartCanvas3, {
                type: 'bar',
                data: {
                    labels: labels,    // X-axis labels (territories)
                    datasets: datasets // Data for each subject
                },
                options: barChartOptions3,
                plugins: [ChartDataLabels] // Register the Data Labels plugin
            });
        {% else %}
            var subjectResults = {{ subject_results | tojson }};

            subjectResults = reorderJsonArray(subjectResults);

            var all_subjects = {{ all_subjects | tojson }};
            var subjects = subjectResultsKeys
                .filter(key => key.endsWith('_avg'))
                .map(key => key.replace('_avg', ''));

            
            var labels = subjectResults.map(item => item.key);

            // Split labels and datasets into two parts
            var midIndex = Math.ceil(labels.length / 2); // Find the midpoint
            var labelsPart1 = labels.slice(0, midIndex);
            var labelsPart2 = labels.slice(midIndex);

            var datasetsPart1 = subjects.map(subject => ({
                label: all_subjects[subject],
                data: subjectResults.slice(0, midIndex).map(item => item[subject + '_avg']),
                backgroundColor: subjectColours[subject],
                borderColor: 'rgba(0, 0, 0, 0.1)',
                borderWidth: 1
            }));

            var datasetsPart2 = subjects.map(subject => ({
                label: all_subjects[subject],
                data: subjectResults.slice(midIndex).map(item => item[subject + '_avg']),
                backgroundColor: subjectColours[subject],
                borderColor: 'rgba(0, 0, 0, 0.1)',
                borderWidth: 1
            }));

            // Define options (reused for both charts)
            var barChartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    yAxes: [{
                        ticks: { beginAtZero: true, max: 100 }
                    }],
                    xAxes: [{
                        barPercentage: 0.6,
                        categoryPercentage: 0.8,
                        ticks: {
                            minRotation: 40,
                            maxRotation: 40,
                            autoSkip: false
                        }
                    }]
                },
                plugins: {
                    datalabels: {
                        anchor: 'end',
                        align: 'top',
                        color: '#000',
                        font: { weight: 'bold', size: 10 }
                    }
                },
                legend: { display: true }
            };

            // Initialize barChart3 for the first part
            var barChartCanvas3 = $('#barChart3_1').get(0).getContext('2d');
            new Chart(barChartCanvas3, {
                type: 'bar',
                data: { labels: labelsPart1, datasets: datasetsPart1 },
                options: barChartOptions,
                plugins: [ChartDataLabels]
            });

            // Initialize barChart4 for the second part
            var barChartCanvas4 = $('#barChart3_2').get(0).getContext('2d');
            barChartOptions2 = barChartOptions;
            barChartOptions2.legend.display = false; // Disable legend display for the second chart

            new Chart(barChartCanvas4, {
                type: 'bar',
                data: { labels: labelsPart2, datasets: datasetsPart2 },
                options: barChartOptions2,
                plugins: [ChartDataLabels]
            });

        {% endif %}
    {% endif %}
</script>
<script>
    {% if some_subject_result and some_subject_result | length > 0 %}
        // Data for avg_by_territory
        var someSubjectResult = {{ some_subject_result | tojson }};
        var all_subjects = {{ all_subjects | tojson }};

        function reorderSubjects(subjectResult) {
            const orderedResult = {}; // Create a new ordered object
            var subjectKeys = {{ subject_results_keys | tojson }}; // Get the subject keys


            // Loop through `subjectKeys` to ensure the order
            subjectKeys.forEach(key => {
                if (key in subjectResult) { // Check if the key exists in the input data
                    orderedResult[key] = subjectResult[key]; // Add it to the ordered object
                }
            });
            return orderedResult;
        }
        // Reorder data for each quarter

        someSubjectResult = reorderSubjects(someSubjectResult);

        // Check if there's a chosen territory provided
        var chosenSubject = "{{ subject }}" // Use Jinja to pass the chosen territory, if any, to JavaScript

        // Parse `some_subject_results` data for Chart.js
        var barChartData4 = {
            labels: Object.keys(someSubjectResult).map(function (key) {
                return all_subjects[key.replace('_avg', '')]; // Parse labels like `math_avg` to `math`
            }),
            datasets: [{
                label: 'Natijalar',
                data: Object.values(someSubjectResult),
                backgroundColor: Object.keys(someSubjectResult).map(function (key) {
                    return key.replace('_avg', '') === chosenSubject ? 'rgba(147, 197, 253, 1)' : 'rgba(30, 58, 138, 1)';
                }),
                borderColor: 'rgba(0,0,0,0.1)',
                borderWidth: 1
            }]
        };

        var barChartCanvas4 = $('#barChart4').get(0).getContext('2d');

        var barChartOptions4 = {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                yAxes: [{
                    ticks: {
                        beginAtZero: true,
                        max: 100 // Set maximum value for y-axis
                    }
                }],
                xAxes: [{
                    ticks: {
                        fontSize: 10,
                        maxRotation: 40,
                        minRotation: 40 // Set vertical label orientation
                    }
                }]
            },
            plugins: {
                datalabels: {
                    anchor: 'end',       // Position the labels at the end (top) of each bar
                    align: 'top',      // Align label at the top center of the bar
                    color: '#000',       // Color of the label text
                    font: {
                        size: 10
                    }
                }
            },
            legend: {
                display: false // Disable legend display
            }
        };

        // Initialize barChart4 with Data Labels plugin
        new Chart(barChartCanvas4, {
            type: 'bar',
            data: barChartData4,
            options: barChartOptions4,
            plugins: [ChartDataLabels]
        });
    {% endif %}
</script>
<script>
    {% if study_class_results and study_class_results | length > 0 %}
        // Data for avg_by_territory
        var someStudyClassResults = {{ study_class_results | tojson }};
        var all_subjects = {{ all_subjects | tojson }};

        // Check if there's a chosen territory provided
        var chosenStudyClass = "{{ studyClass }}" // Use Jinja to pass the chosen territory, if any, to JavaScript
        var chosenSubject = "{{ subject }}" // Use Jinja to pass the chosen territory, if any, to JavaScript

        var labels = someStudyClassResults.map(item => item.studyclass + '-sinf');
        var data = someStudyClassResults.map(item => item.avg);


        if (chosenSubject) {
            label = all_subjects[chosenSubject];  
        }
        else {
            label = 'Barcha fanlar';
        }

        // Parse `some_subject_results` data for Chart.js
        var barChartData5 = {
            labels: labels,
            datasets: [{
                label: label,
                data: data,
                backgroundColor: someStudyClassResults.map(item =>
                    item.studyclass === chosenStudyClass ? 'rgba(147, 197, 253, 1)' : 'rgba(30, 58, 138, 1)'
                ),
                borderColor: 'rgba(0,0,0,0.1)',
                borderWidth: 1
            }]
        };

        var barChartCanvas5 = $('#barChart5').get(0).getContext('2d');

        var barChartOptions5 = {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                yAxes: [{
                    ticks: {
                        beginAtZero: true,
                        max: 100 // Set maximum value for y-axis
                    }
                }],
                xAxes: [{
                    ticks: {
                        fontSize: 10
                    }
                }]
            },
            plugins: {
                datalabels: {
                    anchor: 'end',       // Position the labels at the end (top) of each bar
                    align: 'top',      // Align label at the top center of the bar
                    color: '#000',       // Color of the label text
                    font: {
                        size: 10
                    }
                }
            },
            legend: {
                display: false // Disable legend display
            }
        };

        // Initialize barChart4 with Data Labels plugin
        new Chart(barChartCanvas5, {
            type: 'bar',
            data: barChartData5,
            options: barChartOptions5,
            plugins: [ChartDataLabels]
        });
    {% endif %}
</script>

{% endblock %}